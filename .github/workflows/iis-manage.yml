name: IIS Manage

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action: status, start, stop, restart'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - start
          - stop
          - restart
      site_name:
        description: 'IIS Site Name'
        required: true

jobs:
  manage:
    name: IIS ${{ github.event.inputs.action }} - ${{ github.event.inputs.site_name }}
    runs-on: [self-hosted, windows, iis]
    steps:
      - name: Manage IIS Site
        shell: powershell
        run: |
          Import-Module WebAdministration -ErrorAction SilentlyContinue
          $siteName = "${{ github.event.inputs.site_name }}"
          $action = "${{ github.event.inputs.action }}"

          Write-Host "=== IIS Site: $siteName ==="

          # Check site exists
          $site = Get-Website -Name $siteName -ErrorAction SilentlyContinue
          if (-not $site) {
            Write-Error "Site '$siteName' not found!"
            Write-Host "`nAvailable sites:"
            Get-Website | Format-Table Name, State, PhysicalPath -AutoSize
            exit 1
          }

          # Show current status
          Write-Host "State: $($site.State)"
          Write-Host "Path: $($site.PhysicalPath)"
          Write-Host "App Pool: $($site.ApplicationPool)"

          # Check app pool
          $pool = Get-WebAppPoolState -Name $site.ApplicationPool -ErrorAction SilentlyContinue
          Write-Host "App Pool State: $($pool.Value)"

          # Check bindings
          Write-Host "`nBindings:"
          Get-WebBinding -Name $siteName | Format-Table protocol, bindingInformation -AutoSize

          # Use appcmd for more reliable control
          $appcmd = "$env:SystemRoot\System32\inetsrv\appcmd.exe"

          switch ($action) {
            "start" {
              & $appcmd start apppool /apppool.name:"$($site.ApplicationPool)" 2>&1
              & $appcmd start site /site.name:"$siteName" 2>&1
              Write-Host "`nStart commands issued."
            }
            "stop" {
              & $appcmd stop site /site.name:"$siteName" 2>&1
              & $appcmd stop apppool /apppool.name:"$($site.ApplicationPool)" 2>&1
              Write-Host "`nStop commands issued."
            }
            "restart" {
              & $appcmd stop site /site.name:"$siteName" 2>&1
              & $appcmd stop apppool /apppool.name:"$($site.ApplicationPool)" 2>&1
              Start-Sleep -Seconds 2
              & $appcmd start apppool /apppool.name:"$($site.ApplicationPool)" 2>&1
              & $appcmd start site /site.name:"$siteName" 2>&1
              Write-Host "`nRestart commands issued."
            }
            "status" {
              Write-Host "`nStatus check complete."
            }
          }

          # Final state
          $siteAfter = Get-Website -Name $siteName
          $poolAfter = Get-WebAppPoolState -Name $siteAfter.ApplicationPool
          Write-Host "`n=== Final State ==="
          Write-Host "Site: $($siteAfter.State)"
          Write-Host "App Pool: $($poolAfter.Value)"
