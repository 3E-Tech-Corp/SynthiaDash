name: Set User Password

on:
  workflow_dispatch:
    inputs:
      email:
        description: 'User email'
        required: true
      password:
        description: 'New password'
        required: true

jobs:
  set-password:
    name: Set Password
    runs-on: [self-hosted, windows, iis]
    steps:
      - name: Generate hash and update
        shell: powershell
        env:
          SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
        run: |
          $email = "${{ github.event.inputs.email }}"
          $password = "${{ github.event.inputs.password }}"
          
          # Generate PBKDF2 hash matching AuthService.cs format
          $rng = New-Object System.Security.Cryptography.RNGCryptoServiceProvider
          $salt = New-Object byte[] 16
          $rng.GetBytes($salt)
          $rng.Dispose()
          
          $deriveBytes = New-Object System.Security.Cryptography.Rfc2898DeriveBytes(
            $password, $salt, 100000, [System.Security.Cryptography.HashAlgorithmName]::SHA256)
          $hash = $deriveBytes.GetBytes(32)
          $deriveBytes.Dispose()
          
          $passwordHash = [Convert]::ToBase64String($salt) + "." + [Convert]::ToBase64String($hash)
          Write-Host "Generated hash for $email"
          
          # Update database
          $sql = "UPDATE Users SET PasswordHash = '$passwordHash' WHERE Email = '$email'; SELECT Id, Email, DisplayName FROM Users WHERE Email = '$email';"
          $result = Invoke-Sqlcmd -ServerInstance "localhost" -Database "Synthia" -Username "ftsql" -Password $env:SQL_PASSWORD -Query $sql
          $result | Format-Table -AutoSize
